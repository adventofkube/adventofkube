name: Make packages public

on:
  push:
    paths:
      - 'images/**'
      - 'charts/**'
  workflow_dispatch:

jobs:
  make-public:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: List and make packages public
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          ORG="adventofkube"

          echo "=== Debug: List all packages ==="
          echo "Trying org packages..."
          gh api "/orgs/$ORG/packages?package_type=container" || echo "Failed to list org packages"

          echo ""
          echo "Trying user packages..."
          gh api "/user/packages?package_type=container" || echo "Failed to list user packages"

          echo ""
          echo "=== Attempting visibility changes ==="
          for pkg in day00 day01 day02 day03 day04 day05 day06 charts/day00 charts/day01 charts/day02 charts/day03 charts/day04 charts/day05 charts/day06; do
            encoded=$(echo "$pkg" | sed 's/\//%2F/g')
            echo "Trying: $pkg (encoded: $encoded)"

            # Try org first
            gh api -X PATCH "/orgs/$ORG/packages/container/$encoded/visibility" -f visibility=public 2>&1 && echo "  ✓ org/$pkg" && continue

            # Try user
            gh api -X PATCH "/user/packages/container/$encoded/visibility" -f visibility=public 2>&1 && echo "  ✓ user/$pkg" && continue

            echo "  ✗ $pkg not found"
          done
