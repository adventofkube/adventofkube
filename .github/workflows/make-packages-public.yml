name: Make packages public

on:
  push:
    paths:
      - 'images/**'
      - 'charts/**'
  workflow_dispatch:

jobs:
  make-public:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Debug token and make packages public
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          ORG="adventofkube"

          echo "=== Step 1: Verify token identity ==="
          gh api /user --jq '{login: .login, type: .type}'

          echo ""
          echo "=== Step 2: Check token scopes ==="
          curl -sI -H "Authorization: Bearer $GH_TOKEN" https://api.github.com/user | grep -i "x-oauth-scopes"

          echo ""
          echo "=== Step 3: Check org membership ==="
          gh api "/orgs/$ORG/memberships/$(gh api /user --jq '.login')" --jq '{role: .role, state: .state}' || echo "Could not get membership"

          echo ""
          echo "=== Step 4: List private packages ==="
          gh api "/orgs/$ORG/packages?package_type=container" --jq '.[] | select(.visibility == "private") | .name'

          echo ""
          echo "=== Step 5: Attempt visibility change with full error ==="
          # Try one package with verbose output
          TEST_PKG="day05"
          echo "Testing PATCH on $TEST_PKG..."

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/orgs/$ORG/packages/container/$TEST_PKG/visibility" \
            -d '{"visibility":"public"}')

          echo "$RESPONSE"
