name: Make packages public

on:
  push:
    paths:
      - 'images/**'
      - 'charts/**'
  workflow_dispatch:

jobs:
  make-public:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Make packages public
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          ORG="adventofkube"

          echo "=== Verify PAT scopes ==="
          curl -sI -H "Authorization: Bearer $GH_TOKEN" https://api.github.com/user | grep -i "x-oauth-scopes"

          echo ""
          echo "=== Finding private packages ==="
          PRIVATE_PKGS=$(gh api "/orgs/$ORG/packages?package_type=container" --jq '.[] | select(.visibility == "private") | .name')

          if [ -z "$PRIVATE_PKGS" ]; then
            echo "No private packages found!"
            exit 0
          fi

          echo "Private packages:"
          echo "$PRIVATE_PKGS"

          echo ""
          echo "=== Making packages public ==="
          for pkg in $PRIVATE_PKGS; do
            encoded=$(echo "$pkg" | sed 's/\//%2F/g')

            OWNER=$(gh api "/orgs/$ORG/packages?package_type=container" \
              --jq ".[] | select(.name==\"$pkg\") | .owner.login")

            echo -n "Setting $pkg (owner=$OWNER) to public... "

            if [ "$OWNER" = "$ORG" ]; then
              URL="https://api.github.com/orgs/$ORG/packages/container/$encoded/visibility"
            else
              URL="https://api.github.com/user/packages/container/$encoded/visibility"
            fi

            RESULT=$(curl -s -w "%{http_code}" -o /tmp/response.json \
              -X PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$URL" \
              -d '{"visibility":"public"}')

            if [ "$RESULT" = "204" ] || [ "$RESULT" = "200" ]; then
              echo "OK"
            else
              echo "FAILED ($RESULT)"
              cat /tmp/response.json
            fi
          done
