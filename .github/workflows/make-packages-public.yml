name: Make packages public

on:
  push:
    paths:
      - 'images/**'
      - 'charts/**'
  workflow_dispatch:

jobs:
  make-public:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: List and make packages public
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          ORG="adventofkube"

          echo "=== Listing all org packages ==="
          gh api "/orgs/$ORG/packages?package_type=container" --jq '.[].name' || echo "Could not list packages"

          echo ""
          echo "=== Making container images public ==="
          for img in day00 day01 day02 day03 day04 day05 day06; do
            echo "Trying $img..."
            gh api -X PATCH "/orgs/$ORG/packages/container/$img/visibility" \
              -f visibility=public && echo "  ✓ $img" || echo "  ✗ $img failed"
          done

          echo ""
          echo "=== Making Helm charts public ==="
          for chart in day00 day01 day02 day03 day04 day05 day06; do
            echo "Trying charts/$chart..."
            gh api -X PATCH "/orgs/$ORG/packages/container/charts%2F$chart/visibility" \
              -f visibility=public && echo "  ✓ charts/$chart" || echo "  ✗ charts/$chart failed"
          done
